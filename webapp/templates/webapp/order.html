{% extends './base.html' %}

{% block title %}Оформление заказа{% endblock %}

{% block head %}
<script type="text/javascript">
    $(document).ready(function () {
        var currentStep = 1;
        var totalSteps = $('.form-step').length;

        // Function to show the current step
        function showStep(step) {
            $('.form-step').addClass('visually-hidden');
            $('#step-' + step).removeClass('visually-hidden');
            updateButtons(step);
        }

        // Function to update navigation buttons
        function updateButtons(step) {
            if (step == 1) {
                $('#prev-step').hide();
            } else {
                $('#prev-step').show();
            }

            if (step == totalSteps) {
                $('#next-step').hide();
            } else {
                $('#next-step').show();
            }
        }

        // Function to update overall price based on form data
        function updateOverallPrice() {
            var totalPrice = 0;

            // Sum up prices of each product
            $('.form-row').each(function () {
                var price = parseFloat($(this).find('[id*="price"]').val()) || 0;
                totalPrice += price;
            });

            totalPrice += parseFloat($('.details-group').find('[id*="price"]').val()) || 0;

            // Display the overall price
            $('.overall-price span').each( function () {
                $(this).text(totalPrice.toFixed(2));
            });
        }

        // Initial
        updateOverallPrice();

        // Calculate overall price on formset input change
        $('.form-step input, select').change(function (e) {
            updateOverallPrice();
        });

        // Next step button click handler
        $('#next-step').click(function (e) {
            e.preventDefault();
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        });

        // Previous step button click handler
        $('#prev-step').click(function (e) {
            e.preventDefault();
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        });

        // Initial setup
        showStep(currentStep);

        // Function to update element indices
        function updateElementIndex(el, prefix, ndx) {
            var id_regex = new RegExp('(' + prefix + '-\\d+)');
            var replacement = prefix + '-' + ndx;
            if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
            if (el.id) el.id = el.id.replace(id_regex, replacement);
            if (el.name) el.name = el.name.replace(id_regex, replacement);
        }

        // Function to clone formset elements
        function cloneMore(selector, prefix) {
            var newElement = $(selector).clone(true, true);
            var total = $('#id_' + prefix + '-TOTAL_FORMS').val();

            $(newElement).find(':input').each(function () {
                updateElementIndex(this, prefix, total);
            });
            $(newElement).find('label').each(function () {
                updateElementIndex(this, prefix, total);
            });

            total++;
            $('#id_' + prefix + '-TOTAL_FORMS').val(total);
            $(selector).before(newElement);

            updateOverallPrice();

            return false;
        }

        // Function to delete formset elements
        function deleteForm(prefix, btn) {
            var total = $('#id_' + prefix + '-TOTAL_FORMS').val();

            if (total != 1) {
                $('#id_' + prefix + '-TOTAL_FORMS').val(total - 1);
                btn.closest('.form-row').remove();
                var forms = $('.form-row');
                for (var i = 0; i < forms.length; i++) {
                    $(forms.get(i)).find(':input').each(function () {
                        updateElementIndex(this, prefix, i);
                    });
                    $(forms.get(i)).find('label').each(function () {
                        updateElementIndex(this, prefix, i);
                    });
                }
            }

            updateOverallPrice();

            return false;
        }

        // Clone formset elements on button click
        $(document).on('click', '.add-form-row', function (e) {
            e.preventDefault();
            cloneMore('#formset-container .form-row:first', 'form');
            return false;
        });

        // Delete formset elements on button click
        $(document).on('click', '.remove-form-row', function (e) {
            e.preventDefault();
            deleteForm('form', $(this));
            return false;
        });

        // Calculate overall price on formset input change
        $('#formset-container select, #formset-container input').change(function (e) {
            $.ajax({
                type: 'POST',
                url: '/order/',
                data: {
                    material: $(e.target).closest('.form-row').find('[id*="material"]').val(),
                    length: $(e.target).closest('.form-row').find('[id*="length"]').val(),
                    width: $(e.target).closest('.form-row').find('[id*="width"]').val(),
                    height: $(e.target).closest('.form-row').find('[id*="height"]').val(),
                    handles: $(e.target).closest('.form-row').find('[id*="handles"]').is(':checked'),
                    legs: $(e.target).closest('.form-row').find('[id*="legs"]').is(':checked'),
                    groove: $(e.target).closest('.form-row').find('[id*="groove"]').is(':checked'),
                    number: $(e.target).closest('.form-row').find('[id*="number"]').val(),
                    price: $(e.target).closest('.form-row').find('[id*="price"]').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                dataType: 'json',
                success: function (responseData) {
                    $(e.target).closest('.form-row').find('[id*=price]').val(responseData.text);
                    updateOverallPrice();
                },
            });
        });

        // Delivery price
        $('.order-details select').change(function (e) {
            $.ajax({
                type: 'POST',
                url: '/order/',
                data: {
                    delivery_type: $(this).val(),
                    address: $(e.target).closest('.order-details').find('[id*="address"]').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                dataType: 'json',
                success: function (responseData) {
                    $(e.target).closest('.order-details').find('[id*=delivery_price]').val(responseData.text);
                    updateOverallPrice();
                },
            });
        });

        // Toggle dynamic fields based on delivery type selection
        $('[id*="delivery_type"]').change(function () {
            if ($(this).val() === '0') {
                $('.dynamic').slideUp();
            } else {
                $('.dynamic').slideDown();
            }
        });


        // Initial
        if ($('[id*="delivery_type"]').val() === '0') {
            $('.dynamic').slideUp();
        }

        // Handle form submission
        $('#order-form').submit(function (e) {
            e.preventDefault();
            $(this).find('[name*="price"]').prop('disabled', false);
            var dataToSend = $(this).serialize();
            $(this).find('[name*="price"]').prop('disabled', true);
            $.ajax({
                type: 'POST',
                url: '/order/',
                data: dataToSend,
                context: this,
                dataType: 'json',
                success: function (responseData) {
                    $(this).closest('.form-outer').addClass('visually-hidden');
                    $('.message-prefix').html(responseData.message_prefix);
                    $('.message-body').html(responseData.message_body + responseData.order_id);
                    $('.message-suffix').html(responseData.message_suffix);
                    $('.post-message').removeClass('visually-hidden');
                },
            });
        });
    });
</script>
{% endblock %}



{% block content %}
<div class="container">
    <div class="form-outer">
        <div class="header-with-price">
            <h2>Новый заказ</h2>
        </div>

        <form id="order-form" method="POST" action="">
            {% csrf_token %}

            <!-- Step 1: Конфигурация товаров -->
            <div id="step-1" class="form-step">
                <div class="row mb-3">
                    <h3 class="col-9">Шаг 1: Конфигурация товаров</h3>
                    <div class="overall-price col-3 text-end">
                        <span class="step-overall-price"></span>
                    </div>
                </div>

                {{ formset.management_form }}
                <div id="formset-container">
                    <div class="row">
                        <!-- <div class="col-1"></div> -->
                        <div class="col-2"><button class="btn btn-success add-form-row">Добавить товар</button></div>
                        <div class="col-10"></div>
                    </div>
                    {% for form in formset %}
                    <div class="form-row mb-3">
                            <!-- Общие характеристики -->
                            <div class="form-section mb-3">
                                <div class="row">
                                    <div class="col-md-8"><h4>Общие характеристики</h4></div>
                                    <div class="col-md-4">
                                        <div class="input-group mb-3">
                                                {{ form.price }}
                                        </div>
                                    </div>
                                </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4">{{ form.material.label_tag }}</div>
                                    <div class="col-md-4">{{ form.use_type.label_tag }}</div>
                                    
                                <div class="row mb-3">
                                    <div class="col-md-4">{{ form.material }}</div>
                                    <div class="col-md-4">{{ form.use_type }}</div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-danger btn-decrement">-</button>
                                    </div>
                                    <div class="col-md-1">
                                        {{ form.number }}
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-success btn-increment">+</button>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-danger remove-form-row"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>

                            

                            <!-- Размеры -->
                            <div class="form-section mb-3">
                                <h4>Размеры</h4>
                                <div class="row mb-3">
                                    <div class="col-md-2">{{ form.length.label_tag }}</div>
                                    <div class="col-md-2">{{ form.width.label_tag }}</div>
                                    <div class="col-md-2">{{ form.height.label_tag }}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-2">{{ form.length }}</div>
                                    <div class="col-md-2">{{ form.width }}</div>
                                    <div class="col-md-2">{{ form.height }}</div>
                                </div>
                            </div>

                            <!-- Дополнительные параметры -->
                            <div class="form-section mb-3">
                                <h4>Дополнительные параметры</h4>
                                <div class="row mb-3">
                                    <div class="col-md-2">{{ form.handles.label_tag }}</div>
                                    <div class="col-md-2">{{ form.legs.label_tag }}</div>
                                    <div class="col-md-2">{{ form.groove.label_tag }}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-2">{{ form.handles }}</div>
                                    <div class="col-md-2">{{ form.legs }}</div>
                                    <div class="col-md-2">{{ form.groove }}</div>
                                </div>
                            </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Step 2: Детали доставки -->
            <div id="step-2" class="form-step visually-hidden">
                <div class="row mb-3">
                    <h3 class="col-9">Шаг 2: Детали доставки</h3>
                    <div class="overall-price col-3 text-end">
                        <span class="step-overall-price"></span>
                    </div>
                </div>
                <div class="order-details">
                    <div class="details-group mb-3">
                        <label>{{ order_form.description.label_tag }}</label>
                        {{ order_form.description }}
                    </div>
                    <div class="details-group mb-3">
                        <label>{{ order_form.delivery_type.label_tag }}</label>
                        {{ order_form.delivery_type }}
                    </div>
                    <div class="details-group mb-3">
                        <label>{{ order_form.delivery_description.label_tag }}</label>
                        {{ order_form.delivery_description }}
                    </div>
                    <div class="details-group mb-3">
                        <label>{{ order_form.address.label_tag }}</label>
                        {{ order_form.address }}
                    </div>
                    <div class="details-group mb-3">
                        <label>{{ order_form.delivery_price.label_tag }}</label>
                        {{ order_form.delivery_price }}
                    </div>
                </div>
            </div>

            <!-- Step 3: Подтверждение -->
            <div id="step-3" class="form-step visually-hidden">
                <div class="row mb-3">
                    <h3 class="col-9">Шаг 3: Подтверждение заказа</h3>
                    <div class="overall-price col-3 text-end">
                        <span class="step-overall-price"></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Оформить заказ</button>
            </div>
        </form>

        <!-- Navigation buttons -->
        <div class="step-navigation mt-3">
            <button id="prev-step" class="btn btn-primary me-3">Назад</button>
            <button id="next-step" class="btn btn-primary">Далее</button>
        </div>
    </div>

    <!-- Success Message -->
    <div class="post-message visually-hidden mt-3">
        <h2 class="message-prefix"></h2>
        <p class="message-body"></p>
        <p class="message-suffix"></p>
    </div>
</div>

{% endblock %}

{% block externals %}
{% endblock %}