{% extends './base.html' %}

{% block title %}Оформление заказа{% endblock %}

{% block head %}
    <style>
        .product-item { margin-bottom: 10px; }
        .expanded { display: block; }
        .collapsed { display: none; }
    </style>
    <script>
        function toggleProduct(id) {
            var elements = document.getElementsByClassName('product-item');
            for (var i = 0; i < elements.length; i++) {
                if (elements[i].id === id) {
                    elements[i].classList.toggle('expanded');
                    elements[i].classList.toggle('collapsed');
                } else {
                    elements[i].classList.add('collapsed');
                    elements[i].classList.remove('expanded');
                }
            }
        }

        function collapseAll() {
            var elements = document.getElementsByClassName('product-item');
            for (var i = 0; i < elements.length; i++) {
                elements[i].classList.add('collapsed');
                elements[i].classList.remove('expanded');
            }
        }
    </script>
{% endblock %}

{% block content %}
        <h1>Список товаров</h1>
        <div>
            <button onclick="toggleProduct('new-product')">Добавить товар</button>
            <div id="new-product" class="product-item expanded">
                <form method="POST">
                    {% csrf_token %}


                    {{ formset.management_form }}
                    <div id="form_set">
                        {% for form in formset.forms %}
                            <table class='no_error'>
                                {{ form.as_table }}
                            </table>
                        {% endfor %}
                    </div>
                    <input type="button" value="Add More" id="add_more">
                    <div id="empty_form" style="display:none">
                        <table class='no_error'>
                            {{ formset.empty_form.as_table }}
                        </table>
                    </div>
                    <script>
                        $('#add_more').click(function() {
                            var form_idx = $('#id_form-TOTAL_FORMS').val();
                            $('#form_set').append($('#empty_form').html().replace(/__prefix__/g, form_idx));
                            $('#id_form-TOTAL_FORMS').val(parseInt(form_idx) + 1);
                        });
                    </script>
                    
                    
                    <button type="submit">Оформить заказ</button>
                </form>
                <script>
                    function cloneMore(selector, type) {
                    var newElement = $(selector).clone(true);
                    var total = $('#id_' + type + '-TOTAL_FORMS').val();
                    newElement.find(':input').each(function() {
                        var name = $(this).attr('name').replace('-' + (total-1) + '-','-' + total + '-');
                        var id = 'id_' + name;
                        $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
                    });
                    newElement.find('label').each(function() {
                        var newFor = $(this).attr('for').replace('-' + (total-1) + '-','-' + total + '-');
                        $(this).attr('for', newFor);
                    });
                    total++;
                    $('#id_' + type + '-TOTAL_FORMS').val(total);
                    $(selector).after(newElement);
                }
                </script>
            </div>
        </div>
        <div id="products">
            {% for product in products %}
                <div id="product-{{ product.id }}" class="product-item collapsed">
                    <div onclick="toggleProduct('product-{{ product.id }}')">
                        <strong>{{ product.name }}</strong> - {{ product.quantity }}
                    </div>
                    <div>
                        <p>Description: {{ product.description }}</p>
                        <p>Price: {{ product.price }}</p>
                        <p>Width: {{ product.width }}</p>
                        <p>Length: {{ product.length }}</p>
                        <p>Material: {{ product.material }}</p>
                        <label>Quantity: <input type="number" value="{{ product.quantity }}" min="1"></label>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div>
            <button onclick="collapseAll()">Описание</button>
        </div>
{% endblock %}