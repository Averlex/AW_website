{% extends './base.html' %}

{% block title %}Оформление заказа{% endblock %}

{% block head %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
        function updateElementIndex(el, prefix, ndx) {
            var id_regex = new RegExp('(' + prefix + '-\\d+)');
            var replacement = prefix + '-' + ndx;
            if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
            if (el.id) el.id = el.id.replace(id_regex, replacement);
            if (el.name) el.name = el.name.replace(id_regex, replacement);
        }

        function cloneMore(selector, prefix) {
            var newElement = $(selector).clone(true, true);
            var total = $('#id_' + prefix + '-TOTAL_FORMS').val();
            
            $(newElement).find(':input').each(function() {
                updateElementIndex(this, prefix, total);
            });
            $(newElement).find('label').each(function() {
                updateElementIndex(this, prefix, total);
            });

            total++;
            $('#id_' + prefix + '-TOTAL_FORMS').val(total);
            console.log($('#id_' + prefix + '-TOTAL_FORMS').val());
            $(selector).before(newElement);
            
            return false;
        }

        function deleteForm(prefix, btn) {
            var total = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());

            if (total !=  1){
                $('#id_' + prefix + '-TOTAL_FORMS').val(total-1);
                btn.closest('.form-row').remove();
                var forms = $('.form-row');
                for (var i=0; i<forms.length; i++) {
                    $(forms.get(i)).find(':input').each(function() {
                        updateElementIndex(this, prefix, i);
                    });
                    $(forms.get(i)).find('label').each(function() {
                        updateElementIndex(this, prefix, i);
                    });
                }
            }

            return false;
        }

        $(document).on('click', '.add-form-row', function(e){
            e.preventDefault();
            cloneMore('#formset-container .form-row:first', 'form');
            return false;
        });
        
        $(document).on('click', '.remove-form-row', function(e){
            e.preventDefault();
            deleteForm('form', $(this));
            return false;
        });

    </script>
{% endblock %}

{% block content %}
        <h1>Новый заказ</h1>
        <div>
            <form method="POST" action="">
                {% csrf_token %}
                
                {{ formset.management_form }}
                <div id="formset-container">

                    <button class="btn btn-success add-form-row">+</button>

                    {% for form in formset %}

                        <div class="row form-row spacer">
                            <div class="col-2">
                            </div>
                            <div class="col-4">
                                <div class="input-group">
                                    <table>
                                        {{form.as_table}}
                                    </table>
                                    <div class="input-group-append">
                                        <button class="btn btn-danger remove-form-row">-</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <table>
                    <div class="details-group static">
                        <tr>
                            <td>{{ order_form.description.label_tag }}</td>
                            <td>{{ order_form.description }}</td>
                        </tr>
                    </div>
                    <div class="details-group static">
                        <tr>
                            <td>{{ order_form.delivery_type.label_tag }}</td>
                            <td>{{ order_form.delivery_type }}</td>
                        </tr>
                    </div>
                    <div class="details-group dynamic" id="dynamic-order">
                        <tr>
                            <td>{{ order_form.delivery_description.label_tag }}</td>
                            <td>{{ order_form.delivery_description }}</td>
                        </tr>
                    </div>
                    <div class="details-group dynamic" id="dynamic-order">
                        <tr>
                            <td>{{ order_form.address.label_tag }}</td>
                            <td>{{ order_form.address }}</td>
                        </tr>
                    </div>
                    <div class="details-group static">
                        <tr>
                            <td>{{ order_form.delivery_price.label_tag }}</td>
                            <td>{{ order_form.delivery_price }}</td>
                        </tr>
                    </div>
                </table>  
                
                <button type="submit">Оформить заказ</button>

            </form>
        
            <div id="empty-form" style="display:none;">
                <div class="form-row">
                    <table>
                        {{ formset.0.as_table }}
                    </table>
                    <button type="button" class="delete-form">Удалить</button>
                </div>
            </div>

        </div>

{% endblock %}

{% block externals %}

{% endblock %}