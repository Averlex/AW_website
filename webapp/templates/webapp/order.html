{% extends './base.html' %}

{% block title %}Оформление заказа{% endblock %}

{% block head %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
        function updateElementIndex(el, prefix, ndx) {
            var id_regex = new RegExp('(' + prefix + '-\\d+)');
            var replacement = prefix + '-' + ndx;
            if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
            if (el.id) el.id = el.id.replace(id_regex, replacement);
            if (el.name) el.name = el.name.replace(id_regex, replacement);
        }

        function cloneMore(selector, prefix) {
            var newElement = $(selector).clone(true, true);
            var total = $('#id_' + prefix + '-TOTAL_FORMS').val();

            $(newElement).find(':input').each(function() {
                updateElementIndex(this, prefix, total);
            });
            $(newElement).find('label').each(function() {
                updateElementIndex(this, prefix, total);
            });

            total++;
            $('#id_' + prefix + '-TOTAL_FORMS').val(total);
            console.log($('#id_' + prefix + '-TOTAL_FORMS').val());
            $(selector).before(newElement);
            
            return false;
        }

        function deleteForm(prefix, btn) {
            var total = $('#id_' + prefix + '-TOTAL_FORMS').val();

            if (total !=  1){
                $('#id_' + prefix + '-TOTAL_FORMS').val(total-1);
                btn.closest('.form-row').remove();
                var forms = $('.form-row');
                for (var i=0; i<forms.length; i++) {
                    $(forms.get(i)).find(':input').each(function() {
                        updateElementIndex(this, prefix, i);
                    });
                    $(forms.get(i)).find('label').each(function() {
                        updateElementIndex(this, prefix, i);
                    });
                }
            }

            return false;
        }

        $(document).on('click', '.add-form-row', function(e){
            e.preventDefault();
            cloneMore('#formset-container .form-row:first', 'form');
            return false;
        });
        
        $(document).on('click', '.remove-form-row', function(e){
            e.preventDefault();
            deleteForm('form', $(this));
            return false;
        });

    </script>
    <script type="text/javascript">
        $().ready(function() {
            const baseTimeout = 1000;

            // function debounce(callback, wait, e) {
            //     let timeout;
                
            //     return (...args) => {
            //         clearTimeout(timeout);
            //         timeout = setTimeout(function () { callback.apply(this, args); }, wait);
            //     }
            // }

            $('#formset-container select,input').change( function (e) {
                $.ajax({
                    type: 'POST',
                    url: '/order/',
                    data: {
                        material: $(e.target).closest('.form-row').find('[name*="material"]').val(),
                        length: $(e.target).closest('.form-row').find('[name*="length"]').val(),
                        width: $(e.target).closest('.form-row').find('[name*="width"]').val(),
                        height: $(e.target).closest('.form-row').find('[name*="height"]').val(),
                        handles: $(e.target).closest('.form-row').find('[name*="handles"]').is(':checked'),
                        legs: $(e.target).closest('.form-row').find('[name*="legs"]').is(':checked'),
                        groove: $(e.target).closest('.form-row').find('[name*="groove"]').is(':checked'),
                        number: $(e.target).closest('.form-row').find('[name*="number"]').val(),
                        price: $(e.target).closest('.form-row').find('[name*="price"]').val(),
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    dataType: 'json',
                    success: function(responseData) {
                        $(e.target).closest('.form-row').find('[id*=price]').val(responseData.text)
                        // console.log(responseData.text, typeof responseData.text);
                    },
                });
            });
        });
    </script>
    <script type="text/javascript">
        $().ready(function() {
            $('.order-details select').change( function (e) {
                $.ajax({
                    type: 'POST',
                    url: '/order/',
                    data: {
                        delivery_type: $(e.target).closest('.form-row').find('[name*="delivery_type"]').val(),
                        address: $(e.target).closest('.form-row').find('[name*="address"]').val(),
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    dataType: 'json',
                    success: function(responseData) {
                        $(e.target).closest('.form-row').find('[id*=delivery_price]').val(responseData.text)
                    },
                });
            });
        });
    </script>
    <script type="text/javascript">
        $().ready(function() {
            function toggleFields(element, target) {
                if ($(element).val() === '0') {
                    $(target).slideUp();
                } else {
                    $(target).slideDown();
                }
            }

            // Initial check
            toggleFields();

            // Check on change
            $('[name*="delivery_type"]').change(function() {
                toggleFields($(this), $(this).closest('.dynamic'));
            });
        });
    </script>
{% endblock %}

{% block content %}
        <h1>Новый заказ</h1>
        <div>
            <form method="POST" action="">
                {% csrf_token %}
                
                {{ formset.management_form }}
                <div id="formset-container">

                    <button class="btn btn-success add-form-row">+</button>

                    {% for form in formset %}

                        <div class="row form-row spacer">
                            <div class="col-1"></div>
                            <div class="col-6">
                                <div class="input-group">
                                    <table>
                                        {{form.as_table}}
                                    </table>
                                    <div class="input-group-append">
                                        <button class="btn btn-danger remove-form-row">-</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-5"></div>
                        </div>
                    {% endfor %}
                </div>

                <div class="row form-row spacer order-details">
                    <div class="col-1"></div>
                    <div class="col-6">
                        <div class="input-group">
                            <table>
                                <div class="details-group static">
                                    <tr>
                                        <th>{{ order_form.description.label_tag }}</th>
                                        <td>{{ order_form.description }}</td>
                                    </tr>
                                </div>
                                <div class="details-group static">
                                    <tr>
                                        <th>{{ order_form.delivery_type.label_tag }}</th>
                                        <td>{{ order_form.delivery_type }}</td>
                                    </tr>
                                </div>
                                <div class="details-group dynamic" id="dynamic-order">
                                    <tr>
                                        <th>{{ order_form.delivery_description.label_tag }}</th>
                                        <td>{{ order_form.delivery_description }}</td>
                                    </tr>
                                </div>
                                <div class="details-group dynamic" id="dynamic-order">
                                    <tr>
                                        <th>{{ order_form.address.label_tag }}</th>
                                        <td>{{ order_form.address }}</td>
                                    </tr>
                                </div>
                                <div class="details-group static">
                                    <tr>
                                        <th>{{ order_form.delivery_price.label_tag }}</th>
                                        <td>{{ order_form.delivery_price }}</td>
                                    </tr>
                                </div>
                            </table> 
                        </div>
                    </div>
                    <div class="col-5"></div>
                </div>

                <button type="submit">Оформить заказ</button>

            </form>

        </div>

{% endblock %}

{% block externals %}

{% endblock %}